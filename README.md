# PetroSoft V1.0 用户手册

> SMI 储层定量表征平台

---

## 目录

1. [系统要求](#1-系统要求)
2. [安装与启动](#2-安装与启动)
3. [界面概览](#3-界面概览)
4. [快速上手](#4-快速上手)
5. [工区管理](#5-工区管理)
6. [数据导入](#6-数据导入)
7. [数据管理](#7-数据管理)
8. [井管理](#8-井管理)
9. [井曲线显示](#9-井曲线显示)
10. [数据文件格式说明](#10-数据文件格式说明)
11. [菜单功能一览](#11-菜单功能一览)
12. [常见问题](#12-常见问题)

---

## 1. 系统要求

| 项目 | 最低版本 | 说明 |
|------|---------|------|
| Node.js | >= 18.0.0 | [下载地址](https://nodejs.org) |
| pnpm | >= 8.0.0 | 启动脚本会自动安装 |
| Python | >= 3.9.0 | [下载地址](https://www.python.org) |
| pip | — | Python 自带 |

**支持平台**: Windows / macOS / Linux

---

## 2. 安装与启动

### 2.1 一键启动（推荐）

**macOS / Linux:**

```bash
chmod +x start.sh
./start.sh
```

**Windows:**

```cmd
start.bat
```

脚本会自动完成以下步骤：
1. 检查 Node.js、pnpm、Python 版本
2. 安装前端依赖（`pnpm install`）
3. 安装后端依赖（`pip install -r server/requirements.txt`）
4. 启动后端 API 服务（端口 20022）
5. 等待后端就绪
6. 启动 Electron 前端（端口 20012）

### 2.2 跳过依赖安装

如果依赖已安装过，可跳过安装步骤直接启动：

```bash
./start.sh --skip       # macOS / Linux
start.bat --skip        # Windows
```

### 2.3 手动启动

**启动后端：**

```bash
cd server
python -m uvicorn main:app --host 127.0.0.1 --port 20022 --reload
```

**启动前端（新终端窗口）：**

```bash
pnpm dev
```

### 2.4 构建发布版本

```bash
# Windows
pnpm build:win

# macOS
pnpm build:mac

# Linux
pnpm build:linux
```

---

## 3. 界面概览

PetroSoft 采用经典桌面应用布局：

```
┌──────────────────────────────────────────────┐
│  菜单栏  文件  数据  井  岩石物理  地震 ...    │
├──────────────────────────────────────────────┤
│  工具栏  [数据管理] [底图] [井曲线] [合成记录]  │
│          [剖面窗口] [叠前窗口] [直方图]         │
│          [交会图] [三维窗口] [正演]             │
├──────────────────────────────────────────────┤
│                                              │
│              标签页工作区域                     │
│         （多窗口标签页切换）                     │
│                                              │
├──────────────────────────────────────────────┤
│  状态栏  工区: xxx  |  就绪  |  v1.0.0        │
└──────────────────────────────────────────────┘
```

### 工具栏按钮

| 按钮 | 功能 | 状态 |
|------|------|------|
| 数据管理 | 打开数据管理对话框 | 可用 |
| 底图 | 底图显示 | 开发中 |
| 井曲线 | 打开井曲线绘图窗口 | 可用 |
| 合成记录 | 合成地震记录 | 开发中 |
| 剖面窗口 | 地震剖面显示 | 开发中 |
| 叠前窗口 | 叠前地震显示 | 开发中 |
| 直方图 | 数据分布直方图 | 开发中 |
| 交会图 | 多参数交会分析 | 开发中 |
| 三维窗口 | 三维可视化 | 开发中 |
| 正演 | 正演模拟 | 开发中 |

---

## 4. 快速上手

以下以 `data/logging1/` 目录中的样本数据为例，演示完整工作流程。

### 第一步：新建工区

1. 点击菜单 **文件 → 新建工区**
2. 输入工区名称（例如 `测试工区`）
3. 点击 **选择目录**，选一个空文件夹作为工区存储路径
4. 点击 **确定**

> 创建成功后，状态栏左侧会显示当前工区名称。

### 第二步：导入井位坐标

1. 点击菜单 **数据 → 井位 → 导入**
2. 数据类型自动选中「井位坐标」
3. 点击 **选择文件**，选 `data/logging1/坐标.txt`
4. 点击 **导入**

> 成功后会提示「导入成功」，3 口井（s1、s2、s3）的坐标信息被写入数据库。

### 第三步：导入测井曲线

1. 点击菜单 **数据 → 曲线 → 导入**
2. 数据类型自动选中「测井曲线」
3. 输入井名：`s1`（需要与坐标中的井名一致）
4. 选择文件 `data/logging1/s1井测井曲线.txt`
5. 点击 **导入**

### 第四步：导入分层数据

1. 点击菜单 **数据 → 分层 → 导入**
2. 选择文件 `data/logging1/分层.txt`
3. 点击 **导入**

### 第五步：查看井曲线

1. 点击工具栏 **井曲线** 按钮
2. 在左侧下拉框选择井（例如 `s1`）
3. 勾选要显示的曲线（例如 GR、DT、DEN）
4. 点击 **绘图**
5. 曲线以纵向多道形式展示，Y 轴为深度（向下递增）

---

## 5. 工区管理

工区是 PetroSoft 的基本工作单元。每个工区对应一个文件夹，内含一个 `petrosoft.db` SQLite 数据库文件。

### 5.1 新建工区

**菜单路径**: 文件 → 新建工区

| 字段 | 说明 |
|------|------|
| 工区名称 | 自定义名称，用于在列表中标识 |
| 存储路径 | 工区数据目录，建议选空文件夹 |

创建后会在指定路径下生成 `petrosoft.db` 数据库文件。

### 5.2 打开工区

**菜单路径**: 文件 → 打开工区

弹出文件夹选择对话框，选择一个包含 `petrosoft.db` 的工区目录即可。

### 5.3 关闭工区

**菜单路径**: 文件 → 关闭工区

关闭当前工区，清空内存中的井数据和选择状态。

### 5.4 工区数据存储

```
工区目录/
└── petrosoft.db          ← SQLite 数据库（所有数据都在这里）
```

数据库包含以下表：

| 表名 | 存储内容 |
|------|---------|
| wells | 井基本信息（名称、坐标、KB、TD） |
| trajectories | 井轨迹（深度、井斜、方位角） |
| curves | 曲线元数据（名称、单位、采样间隔） |
| curve_data | 曲线数值数据（深度-值对） |
| layers | 分层数据（层位、顶底深度） |
| lithology | 岩性描述 |
| interpretations | 解释结论 |
| discrete_curves | 离散曲线数据 |

---

## 6. 数据导入

### 6.1 导入入口

有两种方式打开导入对话框：

1. **菜单方式**: 数据 → 选择数据类型 → 导入（会自动预选数据类型）
2. **数据管理方式**: 数据管理窗口中点击 **导入数据** 按钮

### 6.2 支持的数据类型

| 数据类型 | 说明 | 是否需要指定井名 |
|---------|------|:---------------:|
| 井位坐标 | 多口井的 X/Y 坐标、KB、TD | 否（文件内含井名） |
| 井轨迹 | 单口井的深度-井斜-方位角 | **是** |
| 测井曲线 | 单口井的多条测井曲线 | **是** |
| 分层 | 多口井的分层信息 | 否（文件内含井名） |
| 岩性 | 多口井的岩性描述 | 否（文件内含井名） |
| 解释结论 | 多口井的综合解释结论 | 否（文件内含井名） |
| 离散曲线 | 单口井的离散测量值 | **是** |

### 6.3 导入步骤

1. 选择 **数据类型**
2. 如需要，填写 **井名**（需与已导入的井位坐标中的井名一致）
3. 点击 **选择文件**，选择对应的数据文件（支持 `.txt`、`.csv`、`.dat`）
4. 点击 **导入**
5. 等待导入完成，查看成功/失败提示

### 6.4 导入顺序建议

推荐按以下顺序导入数据：

```
① 井位坐标  →  ② 井轨迹  →  ③ 测井曲线
                              ↓
④ 分层      ←  ⑤ 岩性    ←  ⑥ 解释结论  ←  ⑦ 离散曲线
```

> **重要**: 井位坐标应最先导入，因为其他数据类型依赖井的存在。对于需要指定井名的数据（井轨迹、测井曲线、离散曲线），必须确保该井已通过坐标数据创建。

---

## 7. 数据管理

**菜单路径**: 数据 → 数据管理
**工具栏**: 数据管理按钮

### 7.1 界面说明

```
┌──────────────────────────────────────────────┐
│  数据管理                               [×]  │
├──────────┬───────────────────────────────────┤
│          │                                   │
│  工区树   │         数据表格                   │
│  ├─ 井1  │  ┌────┬────┬────┬────┐           │
│  │  ├曲线 │  │ 列1 │ 列2 │ 列3 │ ...│           │
│  │  ├分层 │  ├────┼────┼────┼────┤           │
│  │  ├岩性 │  │    │    │    │    │           │
│  │  └结论 │  │    │    │    │    │           │
│  ├─ 井2  │  └────┴────┴────┴────┘           │
│  └─ 井3  │                                   │
├──────────┴───────────────────────────────────┤
│  [导入数据]                        [刷新]     │
└──────────────────────────────────────────────┘
```

### 7.2 使用方法

- **左侧树形结构**: 展开工区 → 井 → 数据类型，点击某个节点查看对应数据
- **右侧数据表格**: 根据选中的节点类型动态展示数据列
  - 点击「井名」节点 → 显示井基本信息
  - 点击「曲线」节点 → 显示该井的曲线列表（名称、单位、采样间隔）
  - 点击「分层」节点 → 显示层位及顶底深度
  - 点击「岩性」节点 → 显示岩性描述及深度范围
  - 点击「解释结论」节点 → 显示解释结论及分类
- **导入数据**: 快速打开导入对话框
- **刷新**: 重新加载树形结构和数据

---

## 8. 井管理

**菜单路径**: 井 → 井管理

打开井列表对话框，以表格形式展示当前工区内所有井的信息：

| 列名 | 说明 |
|------|------|
| 井名 | 井的名称标识 |
| X坐标 | 井口 X 坐标 |
| Y坐标 | 井口 Y 坐标 |
| KB | 补心海拔（米） |
| TD | 井底深度（米） |

**操作**: 双击某行可选中该井，选中状态会同步到井曲线显示等其他功能中。

---

## 9. 井曲线显示

**工具栏**: 井曲线按钮

### 9.1 界面说明

```
┌──────────────────────────────────────────────┐
│  井曲线显示                             [×]  │
├────────┬─────────────────────────────────────┤
│        │                                     │
│ 选择井  │          曲线绘图区域                 │
│ [▼ s1] │                                     │
│        │   GR    │  DT   │  DEN  │  ...      │
│ 选择曲线 │   ←─→   │  ←─→  │  ←─→  │          │
│ ☑ GR   │ ┊      │┊     │┊     │          │
│ ☑ DT   │ ┊  ╲   │┊  │  │┊ ─╲  │  深度     │
│ ☐ DEN  │ ┊   ╲  │┊  │  │┊   ╲ │  (米)     │
│ ☐ SP   │ ┊  ╱   │┊  │  │┊  ╱  │   ↓       │
│ ☐ ...  │ ┊ ╱    │┊  │  │┊ ╱   │          │
│        │ ┊╱     │┊  ╱  │┊╱    │          │
│ [绘图]  │        │      │      │          │
│        │                                     │
└────────┴─────────────────────────────────────┘
```

### 9.2 使用步骤

1. 在左侧 **选择井** 下拉框中选择一口井
2. 系统自动加载该井可用的曲线列表
3. **勾选**要显示的曲线（可多选）
4. 点击 **绘图** 按钮
5. 右侧绘图区域显示曲线

### 9.3 图表交互

| 操作 | 效果 |
|------|------|
| 鼠标悬停 | 显示当前深度和各曲线值的提示框 |
| 鼠标滚轮 | 缩放深度范围 |
| 左侧滑块 | 拖动调整深度显示范围 |

### 9.4 显示特性

- 每条曲线独占一个水平刻度轴（X 轴）
- 所有曲线共享一个垂直深度轴（Y 轴，向下为深度增加方向）
- 曲线使用 12 种不同颜色自动区分
- 数据中 `-9999` 的空值点会被自动过滤

---

## 10. 数据文件格式说明

所有数据文件统一使用 **GB2312 编码**。

### 10.1 井位坐标（坐标.txt）

**分隔符**: Tab
**格式**: 含标题行

```
井名	x坐标	y坐标	KB	Depth
s1	2356780.00	567808.00	250.00	3900.00
s2	2356800.00	567900.00	248.00	3850.00
s3	2356850.00	567850.00	252.00	3950.00
```

| 列 | 说明 |
|----|------|
| 井名 | 井名称 |
| x坐标 | X 坐标（米） |
| y坐标 | Y 坐标（米） |
| KB | 补心海拔（米） |
| Depth | 完钻深度（米） |

### 10.2 井轨迹（井轨迹.csv）

**分隔符**: 空格
**格式**: 含标题行，单井文件

```
深度 井斜 方位角
0.00 0.00 0.00
25.00 0.18 159.41
50.00 0.42 161.14
```

| 列 | 说明 |
|----|------|
| 深度 | 测量深度（米） |
| 井斜 | 井斜角（度） |
| 方位角 | 方位角（度） |

### 10.3 测井曲线（s1井测井曲线.txt）

**分隔符**: Tab
**格式**: 含标题行，单井文件，`-9999` 表示空值

```
深度	孔隙度	含油饱和度	天然伽马值	密度(岩石)	声时差	...
2090.000	-9999.000	-9999.000	87.310	2.568	237.210	...
2090.125	-9999.000	-9999.000	86.450	2.571	236.850	...
```

- 第一列固定为深度
- 后续列为各条测井曲线
- 采样间隔通常为 0.125 米
- `-9999` 或 `-9999.000` 表示无效值，导入时自动转为空值

### 10.4 分层（分层.txt）

**分隔符**: Tab
**格式**: 含标题行，多井文件

```
井名	层号	顶深	底深	厚度	岩性
朝阳井1HF	1	1380.0	1400.5	20.5	砂砾岩系
朝阳井1HF	2	1400.5	1425.0	24.5	泥岩
```

### 10.5 岩性（岩性.txt）

**分隔符**: Tab
**格式**: 含标题行，多井文件

```
井名	层号	顶深	底深	厚度	岩性描述
朝阳井1HF	1	1380.0	1383.4	3.4	灰色粉砂岩
朝阳井1HF	2	1383.4	1385.5	2.1	砂质泥岩
```

### 10.6 解释结论（解释结论.txt）

**分隔符**: Tab
**格式**: 含标题行，多井文件

```
井名	层号	顶深	底深	厚度	有效厚度	综合结论
朝阳井1HF	1	1385.5	1387.0	1.5	0.8	薄砂
朝阳井1HF	2	1387.0	1400.5	13.5	5.2	泥砂
```

### 10.7 离散曲线（离散曲线.txt）

**分隔符**: Tab
**格式**: 含标题行，单井文件，数据行可能有前导 Tab

```
深度	Tmax
	1202.000	441.000
	1202.500	440.000
	1203.000	443.000
```

> 注意：数据行前可能有一个前导 Tab 字符，解析器会自动处理。

---

## 11. 菜单功能一览

### 文件 (F)

| 菜单项 | 快捷方式 | 状态 |
|--------|---------|------|
| 新建工区 | — | 可用 |
| 打开工区 | — | 可用 |
| 保存工区 | — | 开发中 |
| 备份核心数据 | — | 开发中 |
| 关闭工区 | — | 可用 |
| 打开标签 | — | 开发中 |
| 保存标签 | — | 开发中 |
| 清除工区缓存 | — | 开发中 |
| SEGY文件浏览 | — | 开发中 |
| SEGY文件合并 | — | 开发中 |
| 最近使用的工区 | — | 开发中 |
| 退出 | — | 可用 |

### 数据 (D)

| 菜单项 | 导入 | 导出 |
|--------|:----:|:----:|
| 井位 | 可用 | 开发中 |
| 井斜 | 可用 | 开发中 |
| 曲线 | 可用 | 开发中 |
| 分层 | 可用 | 开发中 |
| 时深 | 开发中 | 开发中 |
| 解释结论 | 可用 | 开发中 |
| 录井 | 开发中 | 开发中 |
| 井点属性 | 开发中 | 开发中 |
| 叠后地震 | 开发中 | 开发中 |
| 层位 | 开发中 | 开发中 |
| 断层棒 | 开发中 | 开发中 |
| 断层多边形 | 开发中 | 开发中 |
| 普通多边形 | 开发中 | 开发中 |
| 叠前地震 | 开发中 | 开发中 |
| 速度体 | 开发中 | 开发中 |
| 速度谱 | 开发中 | 开发中 |
| 等值线图 | 开发中 | 开发中 |
| 数据管理 | 可用 | — |

### 井 (L)

| 菜单项 | 状态 |
|--------|------|
| 井管理 | 可用 |
| 新建井组 | 开发中 |
| 曲线编辑 | 开发中 |
| 异常值处理 | 开发中 |
| 曲线重采样 | 开发中 |
| 基线校正 | 开发中 |
| 标准化 | 开发中 |
| 归一化 | 开发中 |
| 提取井点属性 | 开发中 |
| 曲线滤波 | 开发中 |
| 曲线计算器 | 开发中 |
| 计算纵波阻抗 | 开发中 |

### 其他菜单

岩石物理、地震、速度、智能解释、模型、叠后反演、叠前反演、深度域反演、断裂成像、应用 — 均为后续版本规划功能。

---

## 12. 常见问题

### Q: 启动时提示端口被占用？

后端默认使用 **20022** 端口，前端使用 **20012** 端口。如果端口冲突：

```bash
# 查看端口占用（macOS/Linux）
lsof -i :20022

# 杀掉占用进程
kill -9 <PID>
```

也可通过环境变量修改后端端口：

```bash
export PETROSOFT_PORT=20023
```

### Q: curl 健康检查超时？

如果系统设置了代理（如 `ALL_PROXY` 环境变量），curl 请求本地地址会走代理导致失败。启动脚本已使用 `--noproxy '*'` 参数绕过代理。如手动测试：

```bash
curl --noproxy '*' http://127.0.0.1:20022/api/health
```

### Q: 导入数据时提示"井不存在"？

需要先导入 **井位坐标** 创建井记录，再导入该井的曲线、轨迹等数据。井轨迹、测井曲线、离散曲线需要手动输入井名，请确保井名与坐标文件中完全一致。

### Q: 数据文件编码问题？

所有数据文件需使用 **GB2312** 编码。如果文件是 UTF-8 编码，可用文本编辑器转换，或使用命令行工具：

```bash
iconv -f UTF-8 -t GB2312 input.txt > output.txt
```

### Q: 曲线显示为空白？

1. 确认已导入曲线数据
2. 在井曲线窗口中选择正确的井
3. 至少勾选一条曲线
4. 点击「绘图」按钮
5. 如果数据全为 `-9999`（空值），曲线会为空

### Q: 工区数据存储在哪里？

工区数据保存在创建工区时指定的目录下，文件名为 `petrosoft.db`（SQLite 数据库）。工区注册信息保存在 `~/.petrosoft/workareas.json` 中。

### Q: 如何备份数据？

直接复制工区目录下的 `petrosoft.db` 文件即可完成备份。恢复时将备份文件放回工区目录。

---

## 附录：后端 API 参考

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/health` | 健康检查 |
| POST | `/api/workarea/create` | 创建工区 |
| GET | `/api/workarea/list` | 列出工区 |
| POST | `/api/workarea/open` | 打开工区 |
| DELETE | `/api/workarea/{name}` | 删除工区 |
| POST | `/api/data/import` | 导入数据 |
| GET | `/api/well/list` | 井列表 |
| GET | `/api/well/{name}/curves` | 曲线列表 |
| GET | `/api/well/{name}/curve-data` | 曲线数据 |
| GET | `/api/well/{name}/layers` | 分层数据 |
| GET | `/api/well/{name}/lithology` | 岩性数据 |
| GET | `/api/well/{name}/interpretation` | 解释结论 |
| GET | `/api/well/{name}/discrete-curves` | 离散曲线 |
| GET | `/api/well/{name}/summary` | 井数据摘要 |

所有 well 相关接口需传 `workarea` 查询参数指定工区路径。

---

*PetroSoft V1.0 — SMI 储层定量表征平台*
*PetroSoft Team*
